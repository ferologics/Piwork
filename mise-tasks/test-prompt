#!/usr/bin/env bash
#MISE description="Send test prompt and wait for response"
set -euo pipefail

MESSAGE="${1:-Hello}"
ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
LOG_FILE="$ROOT_DIR/tmp/dev/piwork.log"

# Check test server is running
if ! nc -z localhost 19385 2>/dev/null; then
    echo "Test server not running. Run: mise run test-start"
    exit 1
fi

# Count existing agent_end + prompt errors
BEFORE=$(grep -c 'agent_end' "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
BEFORE_ERR=$(grep -c '"command":"prompt","success":false' "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
[[ -z "$BEFORE" ]] && BEFORE=0
[[ -z "$BEFORE_ERR" ]] && BEFORE_ERR=0

# Send prompt
echo "Sending: $MESSAGE"
echo "{\"cmd\":\"prompt\",\"message\":\"$MESSAGE\"}" | nc -w 2 localhost 19385

# Wait for new agent_end event or error
echo "Waiting for response..."
TIMEOUT=120
for i in $(seq 1 $((TIMEOUT * 2))); do
    AFTER=$(grep -c 'agent_end' "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
    AFTER_ERR=$(grep -c '"command":"prompt","success":false' "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
    [[ -z "$AFTER" ]] && AFTER=0
    [[ -z "$AFTER_ERR" ]] && AFTER_ERR=0

    if [[ "$AFTER" -gt "$BEFORE" ]]; then
        RESPONSE=$(python - "$LOG_FILE" <<'PY'
import json
import sys

log_path = sys.argv[1]
lines = open(log_path, encoding="utf-8", errors="ignore").read().splitlines()

for line in reversed(lines):
    if "received:" not in line:
        continue
    if '"type":"message_end"' not in line or '"role":"assistant"' not in line:
        continue

    raw = line.split("received: ", 1)[1]
    try:
        inner = json.loads(raw)
        payload = json.loads(inner) if isinstance(inner, str) else inner
    except Exception:
        continue

    message = payload.get("message") if isinstance(payload, dict) else None
    if not isinstance(message, dict):
        continue

    content = message.get("content")
    if not isinstance(content, list):
        continue

    text_parts = []
    for part in content:
        if isinstance(part, dict) and part.get("type") == "text":
            text = part.get("text")
            if isinstance(text, str):
                text_parts.append(text)

    if text_parts:
        print("".join(text_parts).strip().replace("\n", "\\n"))
        sys.exit(0)

print("")
PY
)
        if [[ -n "$RESPONSE" ]]; then
            echo "✓ Response: $RESPONSE"
        else
            echo "✓ Response complete"
        fi
        exit 0
    fi

    if [[ "$AFTER_ERR" -gt "$BEFORE_ERR" ]]; then
        echo "✗ Prompt failed (see log for error)"
        tail -20 "$LOG_FILE"
        exit 1
    fi

    sleep 0.5
done

echo "Timeout waiting for response"
exit 1
