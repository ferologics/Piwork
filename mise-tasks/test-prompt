#!/usr/bin/env bash
#MISE description="Send test prompt and wait for response"
set -euo pipefail

MESSAGE="${1:-Hello}"
ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
LOG_FILE="$ROOT_DIR/tmp/dev/piwork.log"

# Check test server is running
if ! nc -z localhost 19385 2>/dev/null; then
    echo "Test server not running. Run: mise run test-start"
    exit 1
fi

# Count existing agent_end + prompt errors
BEFORE=$(grep -c 'agent_end' "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
BEFORE_ERR=$(grep -c '"command":"prompt","success":false' "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
[[ -z "$BEFORE" ]] && BEFORE=0
[[ -z "$BEFORE_ERR" ]] && BEFORE_ERR=0

# Send prompt
echo "Sending: $MESSAGE"
echo "{\"cmd\":\"prompt\",\"message\":\"$MESSAGE\"}" | nc -w 2 localhost 19385

# Wait for new agent_end event or error
echo "Waiting for response..."
TIMEOUT=120
for i in $(seq 1 $((TIMEOUT * 2))); do
    AFTER=$(grep -c 'agent_end' "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
    AFTER_ERR=$(grep -c '"command":"prompt","success":false' "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
    [[ -z "$AFTER" ]] && AFTER=0
    [[ -z "$AFTER_ERR" ]] && AFTER_ERR=0

    if [[ "$AFTER" -gt "$BEFORE" ]]; then
        echo "✓ Response complete"
        exit 0
    fi

    if [[ "$AFTER_ERR" -gt "$BEFORE_ERR" ]]; then
        echo "✗ Prompt failed (see log for error)"
        tail -20 "$LOG_FILE"
        exit 1
    fi

    sleep 0.5
done

echo "Timeout waiting for response"
exit 1
