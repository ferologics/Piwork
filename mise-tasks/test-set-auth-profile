#!/usr/bin/env bash
#MISE description="Set active auth profile in UI, restart runtime, wait until applied"
set -euo pipefail

RAW_PROFILE="${1:-default}"
ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
LOG_FILE="$ROOT_DIR/tmp/dev/piwork.log"

normalize_profile() {
    local value="$1"
    local trimmed

    trimmed=$(printf "%s" "$value" | awk '{$1=$1;print}')

    if [[ -z "$trimmed" ]]; then
        echo "default"
        return
    fi

    if [[ "$trimmed" == *".."* ]]; then
        echo "default"
        return
    fi

    if [[ ! "$trimmed" =~ ^[A-Za-z0-9._-]+$ ]]; then
        echo "default"
        return
    fi

    echo "$trimmed"
}

PROFILE=$(normalize_profile "$RAW_PROFILE")

if ! nc -z localhost 19385 2>/dev/null; then
    echo "Test server not running. Run: mise run test-start"
    exit 1
fi

BEFORE_LINES=0
if [[ -f "$LOG_FILE" ]]; then
    BEFORE_LINES=$(wc -l < "$LOG_FILE" | tr -d ' ')
fi

if [[ "$PROFILE" != "$RAW_PROFILE" ]]; then
    echo "Normalized auth profile '$RAW_PROFILE' -> '$PROFILE'"
fi

RESULT=$(python - "$PROFILE" <<'PY' | nc -w 2 localhost 19385
import json
import sys

payload = {
    "cmd": "set_auth_profile",
    "profile": sys.argv[1],
}
print(json.dumps(payload))
PY
)

if [[ "$RESULT" == ERR:* ]]; then
    echo "$RESULT"
    exit 1
fi

echo "$RESULT"

echo "Waiting for auth profile to apply: $PROFILE"
HAS_AUTH=0
HAS_READY=0

for _ in $(seq 1 60); do
    echo '{"cmd":"dump_state"}' | nc -w 2 localhost 19385 >/dev/null || true
    sleep 0.25

    if [[ ! -f "$LOG_FILE" ]]; then
        continue
    fi

    NEW_LOG=$(tail -n +$((BEFORE_LINES + 1)) "$LOG_FILE")

    if grep -F "auth=$PROFILE" -q <<<"$NEW_LOG"; then
        HAS_AUTH=1
    fi

    if grep -F "[RpcClient] vm_event: ready" -q <<<"$NEW_LOG"; then
        HAS_READY=1
    fi

    if grep -E "connectRpc error|vm_event: error|Failed to initialize runtime service" -q <<<"$NEW_LOG"; then
        echo "Auth profile apply encountered runtime error"
        tail -n 80 "$LOG_FILE"
        exit 1
    fi

    if [[ "$HAS_AUTH" -eq 1 && "$HAS_READY" -eq 1 ]]; then
        echo "âœ“ Applied auth profile: $PROFILE"
        exit 0
    fi

done

echo "Timed out waiting for auth profile apply: $PROFILE"
if [[ -f "$LOG_FILE" ]]; then
    tail -n 80 "$LOG_FILE"
fi
exit 1
