#!/usr/bin/env bash
#MISE description="Set API key in auth store for a profile (test harness)"
set -euo pipefail

PROVIDER="${1:-}"
KEY="${2:-}"
PROFILE="${3:-default}"

if [[ -z "$PROVIDER" || -z "$KEY" ]]; then
    echo "Usage: mise run test-auth-set-key <provider> <key> [profile]"
    exit 1
fi

if ! nc -z localhost 19385 2>/dev/null; then
    echo "Test server not running. Run: mise run test-start"
    exit 1
fi

RESULT=$(python - "$PROVIDER" "$KEY" "$PROFILE" <<'PY' | nc -w 2 localhost 19385
import json
import sys

payload = {
    "cmd": "auth_set_api_key",
    "provider": sys.argv[1],
    "key": sys.argv[2],
    "profile": sys.argv[3],
}
print(json.dumps(payload))
PY
)

if [[ "$RESULT" == ERR:* ]]; then
    echo "$RESULT"
    exit 1
fi

echo "$RESULT"
