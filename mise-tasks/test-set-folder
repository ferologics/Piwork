#!/usr/bin/env bash
#MISE description="Set test working folder and restart VM"
set -euo pipefail

FOLDER="${1:-$HOME/dev/pui/tmp/test-workdir}"
ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
LOG_FILE="$ROOT_DIR/tmp/dev/piwork.log"

# Check test server is running
if ! nc -z localhost 19385 2>/dev/null; then
    echo "Test server not running. Run: mise run dev-start"
    exit 1
fi

echo "Setting folder: $FOLDER"
echo "{\"cmd\":\"set_folder\",\"folder\":\"$FOLDER\"}" | nc -w 2 localhost 19385

# Wait for VM to restart (look for new READY)
echo "Waiting for VM restart..."
sleep 2

# Check the VM log for mounted folder
if grep -q "Mounted working folder" "$HOME/Library/Application Support/com.pi.work/vm/qemu.log"; then
    echo "✓ Working folder mounted!"
else
    echo "⚠ Working folder not mounted (check QEMU log)"
fi
