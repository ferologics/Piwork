#!/usr/bin/env bash
#MISE description="Verify task resume + session isolation"
set -euo pipefail

ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
LOG_FILE="$ROOT_DIR/tmp/dev/piwork.log"
QEMU_LOG="$HOME/Library/Application Support/com.pi.work/vm/qemu.log"

# Start fresh
mise run test-start

function dump_state() {
    mise run test-dump-state >/dev/null
    sleep 0.5
    python - "$LOG_FILE" <<'PY'
import re,sys
lines=open(sys.argv[1]).read().splitlines()
for line in reversed(lines):
    if "TestHarness] state:" in line:
        print(line)
        break
PY
}

function parse_state() {
    python - "$1" <<'PY'
import re,sys
line=sys.argv[1]
pattern=r"task=(?P<task>[^ ]+) session=(?P<session>[^ ]+) folder=(?P<folder>[^ ]+) messages=(?P<messages>\d+) streaming=(?P<streaming>\w+)"
m=re.search(pattern,line)
if not m:
    raise SystemExit("Failed to parse state")
print(m.group('task'))
print(m.group('session'))
print(m.group('messages'))
PY
}

function get_session_from_qemu() {
    if [[ ! -f "$QEMU_LOG" ]]; then
        echo ""
        return
    fi
    grep "Session file" "$QEMU_LOG" | tail -1 | sed 's/.*Session file: //'
}

echo "Creating Task A..."
mise run test-create-task "Resume A" >/dev/null
STATE_LINE=$(dump_state)
read -r TASK_A SESSION_A MSG_A < <(parse_state "$STATE_LINE")

if ! mise run test-prompt "alpha hello" >/dev/null; then
    if grep -q "Authentication failed" "$LOG_FILE"; then
        echo "Auth failed. Rebuild runtime with PIWORK_COPY_AUTH=1 or run /login."
    fi
    exit 1
fi

STATE_LINE=$(dump_state)
read -r TASK_A SESSION_A MSG_A < <(parse_state "$STATE_LINE")

if [[ "$MSG_A" -eq 0 ]]; then
    echo "Task A messages did not persist"
    exit 1
fi

QEMU_SESSION=$(get_session_from_qemu)
if [[ -n "$QEMU_SESSION" && "$QEMU_SESSION" != "$SESSION_A" ]]; then
    echo "QEMU session mismatch for Task A"
    echo "Expected: $SESSION_A"
    echo "Actual:   $QEMU_SESSION"
    exit 1
fi

echo "Creating Task B..."
mise run test-create-task "Resume B" >/dev/null
mise run test-prompt "beta hello" >/dev/null
STATE_LINE=$(dump_state)
read -r TASK_B SESSION_B MSG_B < <(parse_state "$STATE_LINE")

if [[ "$TASK_B" == "$TASK_A" ]]; then
    echo "Task B ID matched Task A"
    exit 1
fi

if [[ "$MSG_B" -eq 0 ]]; then
    echo "Task B messages did not persist"
    exit 1
fi

QEMU_SESSION=$(get_session_from_qemu)
if [[ -n "$QEMU_SESSION" && "$QEMU_SESSION" != "$SESSION_B" ]]; then
    echo "QEMU session mismatch for Task B"
    echo "Expected: $SESSION_B"
    echo "Actual:   $QEMU_SESSION"
    exit 1
fi

echo "Switching back to Task A..."
mise run test-set-task "$TASK_A" >/dev/null
sleep 2
STATE_LINE=$(dump_state)
read -r TASK_A_BACK SESSION_A_BACK MSG_A_BACK < <(parse_state "$STATE_LINE")

if [[ "$TASK_A_BACK" != "$TASK_A" ]]; then
    echo "Failed to switch back to Task A"
    exit 1
fi

if [[ "$SESSION_A_BACK" != "$SESSION_A" ]]; then
    echo "Session file mismatch after resume"
    echo "Expected: $SESSION_A"
    echo "Actual:   $SESSION_A_BACK"
    exit 1
fi

if [[ "$MSG_A_BACK" -eq 0 ]]; then
    echo "Task A conversation not restored"
    exit 1
fi

echo "âœ“ Task resume + session isolation verified"
