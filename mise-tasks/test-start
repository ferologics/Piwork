#!/usr/bin/env bash
#MISE description="Start Piwork for automated testing, wait for ready"
set -euo pipefail

ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
LOG_FILE="$ROOT_DIR/tmp/dev/piwork.log"
mkdir -p "$ROOT_DIR/tmp/dev"

# Kill existing
pkill -9 piwork 2>/dev/null || true
pkill -9 qemu-system 2>/dev/null || true
sleep 1

# Start app
echo "Starting Piwork..."
nohup mise run tauri-dev > "$LOG_FILE" 2>&1 &
APP_PID=$!

# Wait for ready signal (test server listening)
echo "Waiting for ready..."
TIMEOUT=60
ELAPSED=0
while ! grep -q "\[test-server\] listening" "$LOG_FILE" 2>/dev/null; do
    sleep 0.5
    ELAPSED=$((ELAPSED + 1))
    if [[ $ELAPSED -ge $((TIMEOUT * 2)) ]]; then
        echo "Timeout waiting for app to start"
        tail -20 "$LOG_FILE"
        exit 1
    fi
done

echo "âœ“ Piwork ready (log: $LOG_FILE)"
