#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)
cd "$ROOT_DIR"

STAGED_FILE_LIST=$(mktemp)
cleanup() {
    rm -f "$STAGED_FILE_LIST"
}
trap cleanup EXIT

git diff --cached --name-only --diff-filter=ACMR -z > "$STAGED_FILE_LIST"

echo "[pre-commit] Auto-formatting code (mise run format)..."
mise run format

if [[ -s "$STAGED_FILE_LIST" ]]; then
    echo "[pre-commit] Re-staging formatted files that were already staged..."
    while IFS= read -r -d '' path; do
        if [[ -e "$path" ]]; then
            git add -- "$path"
        fi
    done < "$STAGED_FILE_LIST"
fi

echo "[pre-commit] Running fast verification gate (mise run check-ci)..."
mise run check-ci
