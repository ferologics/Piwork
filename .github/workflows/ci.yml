name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  changes:
    name: detect integration-impacting changes
    runs-on: ubuntu-latest
    outputs:
      integration: ${{ steps.filter.outputs.integration }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            integration:
              - "runtime/**"
              - "src-tauri/src/**"
              - "src/lib/components/layout/**"
              - "src/lib/services/runtimeService.ts"
              - "src/lib/stores/runtimeDebugStore.ts"
              - "src/lib/stores/taskStore.ts"
              - "src/lib/__tests__/integration/**"
              - "mise.toml"
              - "mise-tasks/test-*"
              - "scripts/testing/**"
              - "scripts/git-hooks/pre-push"
              - ".github/workflows/ci.yml"

  check:
    name: check (fast)
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup mise
        uses: jdx/mise-action@v2

      - name: Install sccache
        run: brew install sccache

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run fast gate
        run: mise run check

  check-full:
    name: check-full (live regressions)
    runs-on: macos-14
    timeout-minutes: 75
    needs: [check, changes]
    if: needs.changes.outputs.integration == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup mise
        uses: jdx/mise-action@v2

      - name: Install runtime deps
        run: brew install qemu sccache

      - name: Install pi CLI for runtime build
        run: npm install -g @mariozechner/pi-coding-agent

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run full live regression gate
        run: mise run test-regressions

      - name: Collect integration diagnostics on failure
        if: failure()
        run: |
          set -euo pipefail

          DEST="tmp/dev/ci-diagnostics"
          mkdir -p "$DEST"

          cp -f tmp/dev/piwork.integration.log "$DEST/" 2>/dev/null || true
          cp -f tmp/dev/piwork.log "$DEST/" 2>/dev/null || true

          MAC_VM_DIR="$HOME/Library/Application Support/com.pi.work/vm"
          LINUX_VM_DIR="$HOME/.local/share/com.pi.work/vm"

          if [ -d "$MAC_VM_DIR" ]; then
            mkdir -p "$DEST/vm-macos"
            cp -R "$MAC_VM_DIR/." "$DEST/vm-macos/" || true
          fi

          if [ -d "$LINUX_VM_DIR" ]; then
            mkdir -p "$DEST/vm-linux"
            cp -R "$LINUX_VM_DIR/." "$DEST/vm-linux/" || true
          fi

          {
            echo "=== Environment ==="
            uname -a || true
            echo
            echo "HOME=$HOME"
            echo
            echo "=== Dest tree ==="
            find "$DEST" -maxdepth 4 -print || true
          } > "$DEST/diagnostics.txt"

      - name: Upload integration diagnostics on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-diagnostics
          path: tmp/dev/ci-diagnostics
          if-no-files-found: ignore
